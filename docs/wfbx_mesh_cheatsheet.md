# wfbX — Mesh TDMA & Time Sync: Шпаргалка (v1)

Краткий перечень параметров и формул для TX/RX. Все времена — в **микросекундах**. Источник времени: `clock_gettime(CLOCK_MONOTONIC_RAW)` (монотоничные «сырые» часы).

---

## Общие параметры
- `T_epoch` — начало **текущего** суперкадра (локальное время узла).
- `T_epoch_len` — длительность суперкадра.
- `T_epoch_gi` — межсуперкадровый guard.
- `δ_us` — суммарная стек-задержка (TX→эфир + эфир→RX), из калибровки.
- `τ_us` — задержка распространения (для RX-оценки; обычно 0).
- `τ_max_us` — максимальная задержка распространения (для TX fit-check; обычно 0).
- `ε_us` — небольшой запас на планировщик/квантование (реком. 250).
- `α` — коэффициент EMA для сглаживания оценки `T_epoch` на RX (0…1; напр. 0.3).

---

## TX: параметры узла
- `T_tx_start` — смещение **своего** слота от `T_epoch`.
- `T_tx_len` — длительность **своего** слота.
- `GI_tx` — хвостовой guard **внутри** слота.
- `phy_cfg` — фактическая конфигурация PHY для инжекции (MCS/GI/BW/STBC/LDPC).

### Окно слота
```text
T_open  = T_epoch + T_tx_start
T_close = T_open + T_tx_len − GI_tx
```

### Проверка «влезет ли кадр» (fit-before-send)
Пусть `A_us_tx = airtime_us_tx(mpdu_len, phy_cfg)` — airtime по **TX-настройкам**.
```text
Отправлять сейчас, если:
now_us + δ_us + A_us_tx + τ_max_us + ε_us <= T_close
Иначе — в свой слот следующего суперкадра.
```

### Трейлер в payload (4B LE)
`TS_tx` — смещение кадра от начала текущего суперкадра:
```c
uint32_t TS_tx = (uint32_t)(now_us - T_epoch);  // ожидаем 0..T_epoch_len
if ((int32_t)TS_tx < 0)   TS_tx += T_epoch_len; // защитный клиппинг
if (TS_tx >= T_epoch_len) TS_tx -= T_epoch_len;
```

---

## RX: параметры и формулы
- `t_loc` — локальная программная метка времени получения.
- `TS_tx_us` — смещение кадра на стороне TX (читаем из 4B трейлера).
- `phy_actual` — фактические поля PHY из radiotap (HT/VHT/HE и пр.).
- `A_us_rx = airtime_us_rx(mpdu_len, phy_actual)` — airtime по **фактическому** PHY.
  > Якорь RX-метки — **конец PPDU**, поэтому airtime всегда вычитаем.

### Оценка начала суперкадра
```text
T_epoch_instant = t_loc − δ_us − A_us_rx − τ_us − TS_tx_us
T̂_epoch        = (1 − α) * T̂_epoch_prev + α * T_epoch_instant   // EMA; α=1 — без сглаживания
```

### Телеметрия (минимум)
```text
e_us = T_epoch_instant − T̂_epoch     // остаточная ошибка
Собираем: среднее/95-й перцентиль(e_us), hit-rate слота (on-time/late/early).
```

---

## Airtime (обе стороны)
- **TX:** считать из **настроенных** параметров PHY (то, чем реально шьём кадр).
- **RX:** считать из **radiotap** (то, что реально пришло).
- Всегда включать преамбулы (L-SIG + HT/VHT/HE-SIG), SERVICE/TAIL и округлять по числу OFDM-символов.
- Для mesh-кадров — **без агрегации** (предсказуемый airtime).

---

## Рекомендуемые дефолты (для старта)
- `δ_us = 1500`, `τ_us = 0`, `τ_max_us = 0`, `ε_us = 250`, `α = 0.3`
- `T_epoch_len = 50_000`, `T_epoch_gi = 0..2_000`
- `GI_tx = 600..800` (дальше можно поджимать по статистике late)
