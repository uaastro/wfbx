# Общая архитектура wfbX

wfbX фреймворк реализованный на микросервисной архитектуре, где основной функционал реализуется в виде отдельного модуля. Все модули условно можно разделить на четыре секции:

- control/orchestration (wfbx_server, ch_server, channel_switcher, ch_proxy)
- radio core (phy/mac, mesh: wfbx_tx/rx/mx, legacy wfb: wfb_tx/rx)
- udp factory (fec, multipath mux/demux, l2tap, udp forwarder/splitter, mav_router_rx/tx)
- stat/monitoring (wfbx_statd, statd_fwd, statd_mav, wfbx_top)

# Базовый радио‑пайплайн wfbX

## Mesh mode

В упрощенном виде основу реализации работы mesh сети обеспечивает возможность одновременной работы нескольких передатчиков (TX) на одной или нескольких частотах, так чтобы не мешать друг другу. Это достигается путем синхронизации таймеров TX (T_epoch) и распределением временного ресурса (time slot) между ними. В контексте wfbx за синхронизацию отвечает модуль wfbx_mx: он слушает эфир и, получая пакеты от разных TX на основе специальных метаданных mesh, постоянно подстраивает локальный T_epoch (время начала суперкадра) и передает эти данные подписанным на него трансмиттерам wfbx_tx (который отвечает за отправку определенного объема данных в свой тайм слот). wfbx_rx отвечает за прием данных соответствующего udp потока и отправку их дальше получателю. Описание параметров модулей wfbx_tx/rx/mx приведено ниже в разделе Radio core (mesh mode). Ниже приведены основные схемы pipeline:

### Термины и связь с параметрами

- T_epoch — начало суперкадра; задается длиной `epoch_len`. Сдвигается mx и используется всеми TX.
- Superframe (суперкадр) — период длиной `epoch_len`, внутри которого нарезаны тайм-слоты разных TX. Между суперкадрами добавляется защитный интервал `epoch_gi`.
- Time slot — окно передачи конкретного TX внутри суперкадра. Начало `slot_start`, длительность `slot_len`, хвостовой guard слота `gi_tx` (урезает T_close).
- T_open/T_close — фактическое открытие/закрытие слота с учетом `slot_start`, `slot_len` и `gi_tx`. T_open = T_epoch + slot_start; T_close = T_open + slot_len – gi_tx.
- GI (guard interval) — защитные интервалы: `epoch_gi` для границы суперкадра, `gi_tx` для хвоста слота.
- Prewake — дробный сон перед T_open/T_next для точного выхода на границу: количество частей `prewake_q`, минимальная длина части `prewake_min`.

### Вариант 1:

| UDP factory | ---> | wfbx_ptx | ---> | wfbx_tx (--mode = ptx, --epoch_sync = off|on) + wfbx_mx | ---> | phy (RTL8812AU) | ---> | Radio Air | ---> | phy (RTL8812AU) | ---> | wfbx_rx | ---> | UDP factory |

### Вариант 2:

| UDP factory | ---> | wfbx_tx (--mode = solo, --epoch_sync = off|on) + wfbx_mx | ---> | phy (RTL8812AU) | ---> | Radio Air | ---> | phy (RTL8812AU) | ---> | wfbx_rx | ---> | UDP factory |


## Legacy mode

| UDP factory | ---> | wfb_tx | ---> | phy (RTL8812AU) | ---> | Radio Air | ---> | phy (RTL8812AU) | ---> | wfb_rx | ---> | UDP factory |

## Когда выбирать pipeline

- Вариант 1 (ptx): нужен, если несколько логических потоков (например, видео + телеметрия) должны идти в один слот под разными `radio_port`; ptx размечает субпотоки, а xtx отправляет их по расписанию под одним group_id, tx_id и link_id. 
- Вариант 2 (solo): когда один поток (например, только видео) полезен если нужно задать жесткий QoS для какого то одного потока при этом КПД использования скорости сети будет меньше. 

## Пример расписания слотов (общие GI/d_max)

| TX | epoch_len (мкс) | epoch_gi (мкс) | slot_start (мкс) | slot_len (мкс) | gi_tx (мкс) | d_max (км) | комментарий |
| --- | --- | --- | --- | --- | --- | --- | --- |
| TX0 | 60000 | 800 | 0 | 20000 | 800 | 20.0 | Первый слот, 20 мс из 60 мс суперкадра старт 0 мс относительно начала суперкадра|
| TX1 | 60000 | 800 | 20000 | 20000 | 800 | 20.0 | Второй слот, 20 мс из 60 мс суперкадра старт 20 мс относительно начала суперкадра|
| TX2 | 60000 | 800 | 40000 | 20000 | 800 | 20.0 | Третий слот, 20 мс из 60 мс суперкадра старт 40 мс относительно начала суперкадра|

Все TX используют одинаковые `epoch_len`, `epoch_gi`, `gi_tx`, `d_max`, `--delta_us`.  `slot_len` можно разделять в ращных пропорциях в зависимости от количества TX и потребности каждого TX в соотвествующей полосе канала, например: как 60/30/10 или 10/45/45, смещая `slot_start` соответственно. Размер суперкадра имеет следующее влияние: чем больше (длиннее) супер кадр (`epoch_len`) тем лучше КПД утилизации скорости канала, и тем больше задержки/пинг, и тем не равномернее задержка/пинг при этом максимальная задержка не будет привышать <= (epoch_len-slot_len)

# Radio Core (mesh mode)

### wfbx_tx (xtx)

- udp: ip:port, на котором принимаем входящий udp поток
`--ip` = 0.0.0.0
`--port` = 5600

- параметры PHY
`--mcs_idx` = 0
`--gi` = short | long
`--bw` = 20
`--ldpc` = 1
`--stbc` = 1

- идентификаторы радио потока
`--group_id` = 0 (id сети)
`--tx_id` = 0 (id передатчика (TX), ключевой идентификатор)
`--link_id` = 0 (дополнительный уровень абстракции на практике практически не используется)
`--radio_port` = 0 (радио порт по сути id потока данных от одного и того же передатчика внутри одной и той же mesh сети)

- режим работы модуля 
`--mode` = ptx|solo (в режиме ptx параметр --radio_port подставляет модуль ptx, параметры group_id, tx_id, и link_id заполняются модулем wfbx_tx таким образом в рамках одного time_slot можно отправлять несколько субпотоков, например video и telem)

- параметры, отвечающие за работу в режиме mesh и синхронизацию
`--mx` = @wfbx.mx  (UDS, подписка на mx - синхронизатор)
`--epoch_len` = 50000 (длина суперкадра. каждому TX отводится один time_slot в рамках одного суперкадра в мкс)
`--epoch_gi` = 800 (защитный интервал суперкадра в мкс)
`--slot_start` = 0 (начало time_slot относительно начала суперкадра в мкс)
`--slot_len` = 50000 (длительность time_slot в мкс)
`--gi_tx` = 800 (защитный интервал слота)
`--delta_us` = 700 (эмпирический параметр оценки ошибки задержки отправки/приема пакета в мкс)
`--d_max` = 0.0 (максимальная дальность между передатчиком и приемником)
`--eps_us` = 250 (параметр мат. ожидания)
`--send_gi` = 10 (коэффициент коррекции расчета airtime в %)
`--prewake_q` = 1 (параметр applied синхронизации)
`--prewake_min` = 1000 (параметр applied синхронизации)
`--epoch_sync` = on (включить/выключить синхронизацию)

из этих параметров важными для пользователя будут: --epoch_len, --slot_start, --slot_len, --d_max, остальные параметры как правило будут применены по умолчанию. Также важно следить за тем, чтобы для всех TX параметры синхронизации, отвечающие за гвард интервалы и d_max, были одинаковы

- параметры, отвечающие за отправку статистики
`--stat_period` = 1000
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_id` = xtx

### xrx (wfbx_rx)

- udp: ip:port, куда перенаправлять полученный поток
`--ip` = 127.0.0.1
`--port` = 5600

- фильтры-идентификаторы радио потока
`--tx_id` = any
`--group_id` = -1
`--link_id` = -1
`--radio_port` = -1

- параметры, отвечающие за отправку статистики
`--stat_period` = 1000
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_id` = xrx

### ptx (wfbx_ptx)

- udp прием и форвардинг на wfbx_tx (xtx)
`--ip` = 0.0.0.0
`--port` = 5600
`--xtx_ip` = 127.0.0.1
`--xtx_port` = 4600

- идентификаторы радио потока (радио порт)
`--radio_port` = 0

- параметры, отвечающие за отправку статистики
`--stat_period` = 1000
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_id` = ptx

### mx (wfbx_mx) (менеджер синхронизации)

- udp
`--ip` = 127.0.0.1
`--port` = 5600

- фильтры-идентификаторы радио потока
`--tx_id` = any
`--group_id` = -1

- параметры, отвечающие за синхронизацию в режиме mesh
`--delta_us` = 700
`--ctrl` = @wfbx.mx
`--d_max` = 0.0

- параметры, отвечающие за отправку статистики
`--stat_period` = 1000
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_id` = mx

# UDP Factory

### udp_proxy_tx (multipath mux)
- udp:
`--mpkts` = 2048
`--ip_rx` = 0.0.0.0
`--port_rx` = 5600
`--ip_tx` = 127.0.0.1
`--port_tx` = 5680
- режимы работы:
`--ptxn` = 1
`--rpn` = 1
`--dl` = 0

### udp_proxy_rx (multipath demux)
- udp:
`--ip_rx` = 0.0.0.0
`--port_rx` = 5600
`--ip_tx` = 127.0.0.1
`--port_tx` = 5700
`--mpkts` = 2048
- режим работы:
`--mode` = 0
- параметры, отвечающие за отправку статистики
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_id` = uprx
`--stat_period` = 1000

### udp_fec_tx
- udp: 
`--mpkts` = 2048
`--ip_rx` = 0.0.0.0
`--port_rx` = 7600
`--ip_tx` = 127.0.0.1
`--port_tx` = 7700
- fec:
`--k` = 3
`--m` = 6

### udp_fec_rx
- udp:
`--mpkts` = 2048
`--ip_rx` = 0.0.0.0
`--port_rx` = 7700
`--ip_tx` = 127.0.0.1
`--port_tx` = 7800
- параметры, отвечающие за отправку статистики
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_id` = ufrx
`--stat_period` = 1000

### l2tap
- udp:
`--ip_rx` = 0.0.0.0
`--port_rx` = 5750
`--ip_tx` = 127.0.0.1
`--port_tx` = 5750
- tap:
`--tap` = wfbxtap0
`--mtu` = 1500
`--bridge` = br0
`--bridge_stp` = auto
- параметры, отвечающие за отправку статистики
`--stat_ip` = 127.0.0.1
`--stat_port` = 9601
`--stat_period` = 1000

### udp_proxy_fwd
- udp: 
`--mpkts` = 2048
`--ip_rx` = 0.0.0.0
`--port_rx` = 5600
`--ip_tx` = 127.0.0.1
`--port_tx` = 5680
- mode:
`--ptxn` = 1
`--rpn` = 1
`--dl` = 0
`--mode` = 0

### uart_to_udp
- uart:
`--uart` = /dev/ttyS0
`--brate` = 115200
- udp:
`--udps_ip` = 127.0.0.1
`--udps_port` = 14775
- mode:
`--mode` = 0

### udp_to_uart
- udp:
`--port_rx` = 14785
`--ip_rx` = 0.0.0.0
- uart:
`--uart` = /dev/ttyS0
`--brate` = 115200

### mav_router_rx
- udp:
`--ip_r` = 0.0.0.0
`--port_r` = 14785
`--ip_mp` = 192.168.144.100
`--port_mp` = 14500
`--ip_rtx` = 192.168.144.125
`--port_rtx` = 14785

### mav_router_tx
- udp:
`--ip_r` = 0.0.0.0
`--port_r` = 14785
- mode
`--mode` = 0
