#!/usr/bin/python3
import os
import psutil
import click
from commentedconfigparser import CommentedConfigParser

def resolve_cfg_path(cfg_path):
    cfg_path = os.path.expanduser(cfg_path)
    if os.path.isabs(cfg_path):
        return cfg_path
    base_dir = os.path.dirname(os.path.abspath(__file__))
    return os.path.normpath(os.path.join(base_dir, cfg_path))

@click.command()
@click.option('--wfb_cfg', default='./wfb_server.cfg', show_default=True, help='target cfg file')
@click.option('--prfx', default='wlx', show_default=True, help='wlan interface prefix')
@click.option('--channel', default='64', show_default=True, help='wifi channel')
@click.option('--wlans_nmbr', default=1, type=int, show_default=True, help='number of wlans to add')
@click.option('--wlan_section', default='wlan', show_default=True, help='wlan section of wfb_cfg file')

def main(wfb_cfg, prfx, channel, wlans_nmbr, wlan_section):
    
    def get_wlans_list(prfx):
        wlans = []
        if_list = psutil.net_if_addrs().keys()
        for if_name in if_list:
            if if_name[:len(prfx)] == prfx:
                wlans.append(if_name)
        
        return wlans
    
#--------------------------------------------
    config = CommentedConfigParser()
    cfg_path = resolve_cfg_path(wfb_cfg)
    config.read(cfg_path)

    wlans_list = get_wlans_list(prfx)
    if not wlans_list:
        print('No WLAN interfaces found with prefix', prfx)
        return

    if wlans_nmbr <= 0:
        print('wlans_nmbr must be greater than zero')
        return

    selected_wlans = wlans_list[:wlans_nmbr]
    if not selected_wlans:
        print('No WLAN interfaces available to update config')
        return

    wlans = ' '.join(selected_wlans)

    if wlan_section not in config:
        print(f"Section '{wlan_section}' not found in {cfg_path}")
        return

    config[wlan_section]['wlan'] = wlans

    with open(cfg_path,'w') as configfile:
        config.write(configfile)

if __name__ == '__main__':
    main()