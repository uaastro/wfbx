#!/usr/bin/python3

import subprocess
import click
import configparser
import os
import atexit
import signal
import sys
import logging
import time
from threading import Thread


def setup_logging(level: str):
    lvl = getattr(logging, level.upper(), logging.INFO)
    logging.basicConfig(level=lvl, format='[%(asctime)s] %(levelname)s %(message)s')


def spawn_module(name, argv, log_mode="off", log_file=None, env=None, cwd=None):
    popen_kwargs = dict(env=env, cwd=cwd, preexec_fn=os.setsid, bufsize=1, text=True)
    fh = None
    if log_mode == "off":
        popen_kwargs.update(stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    elif log_mode == "file":
        if not log_file:
            log_file = f"{name}.log"
        # Ensure directory exists for file-based logging
        try:
            dname = os.path.dirname(log_file)
            if dname:
                os.makedirs(dname, exist_ok=True)
        except Exception:
            pass
        fh = open(log_file, "a", buffering=1)
        popen_kwargs.update(stdout=fh, stderr=subprocess.STDOUT)
    else:
        popen_kwargs.update(stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    p = subprocess.Popen(argv, **popen_kwargs)
    if log_mode == "stderr" and p.stdout is not None:
        def pump(proc, tag):
            for line in proc.stdout:
                logging.info("[%s] %s", tag, line.rstrip())
        t = Thread(target=pump, args=(p, name), daemon=True)
        t.start()
    return p, fh


def kill_all(pl, timeout_ms=10):
    for rec in pl:
        p = rec["proc"]
        try:
            os.killpg(p.pid, signal.SIGTERM)
        except Exception:
            pass
    deadline = time.time() + timeout_ms / 1000.0
    for rec in pl:
        p = rec["proc"]
        while p.poll() is None and time.time() < deadline:
            time.sleep(0.05)
    for rec in pl:
        p = rec["proc"]
        if p.poll() is None:
            try:
                os.killpg(p.pid, signal.SIGKILL)
            except Exception:
                pass
    for rec in pl:
        fh = rec.get("fh")
        if fh:
            try:
                fh.close()
            except Exception:
                pass
    pl.clear()

killed_patterns = set()

def kill_stale_process(pattern):
    if pattern in killed_patterns:
        return
    try:
        subprocess.run(['pkill', '-9', '-f', pattern], check=False, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    except Exception as exc:
        print(f'kill_stale_process failed for {pattern}: {exc}')
    killed_patterns.add(pattern)

def resolve_cfg_path(base_dir, cfg_path):
    cfg_path = os.path.expanduser(cfg_path)
    if os.path.isabs(cfg_path):
        return cfg_path
    return os.path.normpath(os.path.join(base_dir, cfg_path))

@click.command()
@click.option('--conf', default="wfbx_server.cfg", help='path to config file')
def main(conf):
    process_list = []  # {name, proc, fh}
    kill_timeout_ms = 10

    def signal_handler(sig, frame):
        kill_all(process_list, timeout_ms=kill_timeout_ms)
        print('wfbX_server was terminated...')
        sys.exit(0)

    def cleanup():
        kill_all(process_list, timeout_ms=kill_timeout_ms)

    atexit.register(cleanup)
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)

    wfbx_server_dir = os.path.dirname(os.path.abspath(__file__)) + "/"
    conf = resolve_cfg_path(wfbx_server_dir, conf)
    config = configparser.ConfigParser()
    config.read(conf)
    sections = config.sections()

    defaults = config['DEFAULT'] if 'DEFAULT' in config else {}
    log_level = defaults.get('log_level', 'INFO')
    setup_logging(log_level)

    process_id = {}

    wfbx_server_version = 'v1.0.1'
    try:
        cfg_ver = config['wfbx_server']['wfbx_server_version']
        kill_timeout_ms = int(config['wfbx_server']['wfbx_kill_timeout_ms'])
    except:
        cfg_ver = defaults.get('wfbx_server_version', 'unknown')
        kill_timeout_ms = int(defaults.get('wfbx_kill_timeout_ms', '10'))
    
    print("starting wfbX-server...\n")
    print(f"wfbX_server_version: {wfbx_server_version}")
    print(f"wfbX_server_version_cfg: {cfg_ver}")

    try:
        for section in sections:
            if section.startswith('wlan'):
                options = config[section]
                wlans = options['wlan'].split()
                channel = options['channel']
                bandwidth = options['bandwidth']
                bw_pf = options['bw_pf']
                # Настройка интерфейсов (оставляем shell=True как в вашей версии)
                for wlan in wlans:
                    subprocess.run(f"ifconfig {wlan} down", shell=True, check=True)
                    subprocess.run(f"iw dev {wlan} set monitor otherbss", shell=True, check=True)
                    subprocess.run(f"iw reg set US", shell=True, check=True)
                    subprocess.run(f"ifconfig {wlan} up", shell=True, check=True)
                    subprocess.run(f"iw dev {wlan} set channel {channel} HT{bandwidth}{bw_pf}", shell=True, check=True)

            elif section.startswith('udp_tx'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_tx",
                        "--ip", options['udp_tx_ip'],
                        "--port", options['udp_tx_port'],
                        "--pksize", options['udp_tx_pksize'],
                        "--pks", options['udp_tx_pks']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('init_wlans'):
                options = config[section]
                script_path = wfbx_server_dir + "init_wlans"
                argv = [
                    script_path,
                    "--wfb_cfg", options.get('iwlx_wfb_cfg', fallback=wfbx_server_dir + 'wfbx_server.cfg'),
                    "--prfx", options.get('iwlx_prfx', fallback='wlx'),
                    "--channel", options.get('iwlx_channel', fallback='64'),
                    "--wlans_nmbr", options.get('iwlx_wlans_nmbr', fallback='1'),
                    "--wlan_section", options.get('iwlx_wlan_section', fallback='wlan'),
                ]
                try:
                    subprocess.run(argv, check=True)
                except Exception as exc:
                    logging.error("init_wlans failed: %s", exc)

            elif section.startswith('udp_proxy_tx'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_proxy_tx",
                        "--ip_tx", options['uptx_ip_tx'],
                        "--port_tx", options['uptx_port_tx'],
                        "--ip_rx", options['uptx_ip_rx'],
                        "--port_rx", options['uptx_port_rx'],
                        "--mpkts", options['uptx_mpkts'],
                        "--ptxn", options['uptx_ptxn'],
                        "--rpn", options['uptx_rpn'],
                        "--dl", options['uptx_dl']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_proxy_rx'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_proxy_rx",
                        "--ip_tx", options['uprx_ip_tx'],
                        "--port_tx", options['uprx_port_tx'],
                        "--ip_rx", options['uprx_ip_rx'],
                        "--port_rx", options['uprx_port_rx'],
                        "--mpkts", options['uprx_mpkts'],
                        "--mode", options['uprx_mode'],
                        "--stat_ip", options.get('uprx_stat_ip', defaults.get('uprx_stat_ip', '127.0.0.1')),
                        "--stat_port", options.get('uprx_stat_port', defaults.get('uprx_stat_port', '9601')),
                        "--stat_id", section,
                        "--stat_period", options.get('uprx_stat_period', defaults.get('uprx_stat_period', '1000'))]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_proxy_fwd'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_proxy_fwd",
                        "--ip_tx", options['upfwd_ip_tx'],
                        "--port_tx", options['upfwd_port_tx'],
                        "--ip_rx", options['upfwd_ip_rx'],
                        "--port_rx", options['upfwd_port_rx'],
                        "--mpkts", options['upfwd_mpkts'],
                        "--ptxn", options['upfwd_ptxn'],
                        "--rpn", options['upfwd_rpn'],
                        "--dl", options['upfwd_dl'],
                        "--mode", options['upfwd_mode']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_interval_tx'):
                options = config[section]
                module_path = wfbx_server_dir + "udp_interval_tx"
                argv = [
                    module_path,
                    "--ip_rx", options['uitx_ip_rx'],
                    "--port_rx", options['uitx_port_rx'],
                    "--ip_tx", options['uitx_ip_tx'],
                    "--port_tx", options['uitx_port_tx'],
                    "--limit_ms", options['uitx_limit_ms'],
                    "--max_len", options['uitx_max_len'],
                ]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_interval_rx'):
                options = config[section]
                module_path = wfbx_server_dir + "udp_interval_rx"
                argv = [
                    module_path,
                    "--ip_rx", options['uirx_ip_rx'],
                    "--port_rx", options['uirx_port_rx'],
                    "--ip_tx", options['uirx_ip_tx'],
                    "--port_tx", options['uirx_port_tx'],
                    "--max_len", options['uirx_max_len'],
                ]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('ch_switcher'):
                options = config[section]
                module_path = wfbx_server_dir + "ch_switcher"
                argv = [
                    module_path,
                    "--wfb_cfg", options.get('chsw_wfb_cfg', fallback=wfbx_server_dir + 'wfbx_server.cfg'),
                    "--ip", options.get('chsw_ip', fallback='127.0.0.1'),
                    "--port", options.get('chsw_port', fallback='14420'),
                    "--ip_server", options.get('chsw_ip_server', fallback='127.0.0.1'),
                    "--port_server", options.get('chsw_port_server', fallback='5858'),
                    "--ch_id", options.get('chsw_ch_id', fallback='100'),
                    "--hb_freq", options.get('chsw_hb_freq', fallback='1'),
                    "--mpkts", options.get('chsw_mpkts', fallback='2048'),
                    "--cmd_prfx", options.get('chsw_cmd_prfx', fallback='chsw'),
                    "--wlan", options.get('chsw_wlan', fallback='wlan'),
                ]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('ch_server'):
                options = config[section]
                module_path = wfbx_server_dir + "ch_server"
                argv = [
                    module_path,
                    "--ip", options.get('chsv_ip', fallback='127.0.0.1'),
                    "--port", options.get('chsv_port', fallback='5858'),
                    "--hb_freq", options.get('chsv_hb_freq', fallback='1'),
                    "--mpkts", options.get('chsv_mpkts', fallback='2048'),
                ]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('ch_proxy'):
                options = config[section]
                module_path = wfbx_server_dir + "ch_proxy"
                argv = [
                    module_path,
                    "--ch_ip", options.get('chpx_ch_ip', fallback='127.0.0.1'),
                    "--ch_port", options.get('chpx_ch_port', fallback='5858'),
                    "--rx_ip", options.get('chpx_rx_ip', fallback='0.0.0.0'),
                    "--rx_port", options.get('chpx_rx_port', fallback='16000'),
                    "--tx_ip", options.get('chpx_tx_ip', fallback='127.0.0.1'),
                    "--tx_port", options.get('chpx_tx_port', fallback='16001'),
                    "--mpkts", options.get('chpx_mpkts', fallback='2048'),
                ]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('uart_to_udp'):
                options = config[section]
                argv = [wfbx_server_dir + "uart_to_udp",
                        "--uart", options['utu_uart'],
                        "--brate", options['utu_brate'],
                        "--udps_port", options['utu_udps_port'],
                        "--mode", options['utu_mode']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('mav_router_rx'):
                options = config[section]
                argv = [wfbx_server_dir + "mav_router_rx",
                        "--ip_r", options['mvrrx_ip_r'],
                        "--port_r", options['mvrrx_port_r'],
                        "--ip_mp", options['mvrrx_ip_mp'],
                        "--port_mp", options['mvrrx_port_mp'],
                        "--ip_rtx", options['mvrrx_ip_rtx'],
                        "--port_rtx", options['mvrrx_port_rtx']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('mav_router_tx'):
                options = config[section]
                argv = [wfbx_server_dir + "mav_router_tx",
                        "--ip_r", options['mvrtx_ip_r'],
                        "--port_r", options['mvrtx_port_r'],
                        "--mode", options['mvrtx_mode']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_fec_tx'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_fec_tx",
                        "--mpkts", options['uftx_mpkts'],
                        "--ip_rx", options['uftx_ip_rx'],
                        "--port_rx", options['uftx_port_rx'],
                        "--ip_tx", options['uftx_ip_tx'],
                        "--port_tx", options['uftx_port_tx'],
                        "--k", options['uftx_k'],
                        "--m", options['uftx_m']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_fec_rx'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_fec_rx",
                        "--mpkts", options['ufrx_mpkts'],
                        "--ip_rx", options['ufrx_ip_rx'],
                        "--port_rx", options['ufrx_port_rx'],
                        "--ip_tx", options['ufrx_ip_tx'],
                        "--port_tx", options['ufrx_port_tx'],
                        "--stat_ip", options.get('ufrx_stat_ip', defaults.get('ufrx_stat_ip', '127.0.0.1')),
                        "--stat_port", options.get('ufrx_stat_port', defaults.get('ufrx_stat_port', '9601')),
                        "--stat_id", section,
                        "--stat_period", options.get('ufrx_stat_period', defaults.get('ufrx_stat_period', '1000'))]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('udp_to_uart'):
                options = config[section]
                argv = [wfbx_server_dir + "udp_to_uart",
                        "--port_rx", options['udtu_port_rx'],
                        "--ip_rx", options['udtu_ip_rx'],
                        "--uart", options['udtu_uart'],
                        "--brate", options['udtu_brate']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('mx'):
                # wfbx_mx
                options = config[section]
                argv = [wfbx_server_dir + "wfbx_mx",
                        "--ip", options['mx_ip'],
                        "--port", options['mx_port'],
                        "--tx_id", options['mx_tx_id'],
                        "--group_id", options['mx_group_id'],
                        "--delta_us", options['mx_delta_us'],
                        "--ctrl", options['mx_ctrl'],
                        "--d_max", options['mx_d_max'],
                        "--stat_period", options['mx_stat_period'],
                        "--stat_ip", options['mx_stat_ip'],
                        "--stat_port", options['mx_stat_port'],
                        "--stat_id", section] + wlans
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('ptx'):
                options = config[section]
                argv = [wfbx_server_dir + "wfbx_ptx",
                        "--ip", options['ptx_ip'],
                        "--port", options['ptx_port'],
                        "--radio_port", options['ptx_radio_port'],
                        "--xtx_ip", options['ptx_xtx_ip'],
                        "--xtx_port", options['ptx_xtx_port'],
                        "--stat_period", options['ptx_stat_period'],
                        "--stat_ip", options['ptx_stat_ip'],
                        "--stat_port", options['ptx_stat_port'],
                        "--stat_id", section]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('xtx'):
                # wfbx_tx
                options = config[section]
                argv = [wfbx_server_dir + "wfbx_tx",
                        "--ip", options['xtx_ip'],
                        "--port", options['xtx_port'],
                        "--mcs_idx", options['xtx_mcs_idx'],
                        "--gi", options['xtx_gi'],
                        "--bw", options['xtx_bw'],
                        "--ldpc", options['xtx_ldpc'],
                        "--stbc", options['xtx_stbc'],
                        "--group_id", options['xtx_group_id'],
                        "--tx_id", options['xtx_tx_id'],
                        "--link_id", options['xtx_link_id'],
                        "--radio_port", options['xtx_radio_port'],
                        "--mode", options['xtx_mode'],
                        "--mx", options['xtx_mx'],
                        "--epoch_len", options['xtx_epoch_len'],
                        "--epoch_gi", options['xtx_epoch_gi'],
                        "--slot_start", options['xtx_slot_start'],
                        "--slot_len", options['xtx_slot_len'],
                        "--gi_tx", options['xtx_gi_tx'],
                        "--delta_us", options['xtx_delta_us'],
                        "--d_max", options['xtx_d_max'],
                        "--eps_us", options['xtx_eps_us'],
                        "--send_gi", options['xtx_send_gi'],
                        "--prewake_q", options['xtx_prewake_q'],
                        "--prewake_min", options['xtx_prewake_min'],
                        "--stat_ip", options['xtx_stat_ip'],
                        "--stat_port", options['xtx_stat_port'],
                        "--stat_id", section,
                        "--stat_period", options['xtx_stat_period'],
                        "--epoch_sync", options['xtx_epoch_sync']] + wlans
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('xrx'):
                # wfbx_rx
                options = config[section]
                argv = [wfbx_server_dir + "wfbx_rx",
                        "--ip", options['xrx_ip'],
                        "--port", options['xrx_port'],
                        "--tx_id", options['xrx_tx_id'],
                        "--group_id", options['xrx_group_id'],
                        "--link_id", options['xrx_link_id'],
                        "--radio_port", options['xrx_radio_port'],
                        "--stat_ip", options['xrx_stat_ip'],
                        "--stat_port", options['xrx_stat_port'],
                        "--stat_id", section,
                        "--stat_period", options['xrx_stat_period']] + wlans
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('tx'):
                # legacy wfb_tx
                options = config[section]
                argv = [wfbx_server_dir + "wfb_tx",
                        "--ip", options['tx_ip'],
                        "--port", options['tx_port'],
                        "--mcs_idx", options['tx_mcs_idx'],
                        "--gi", options['tx_gi'],
                        "--bw", options['tx_bw'],
                        "--ldpc", options['tx_ldpc'],
                        "--stbc", options['tx_stbc'],
                        "--group_id", options['tx_group_id'],
                        "--tx_id", options['tx_tx_id'],
                        "--link_id", options['tx_link_id'],
                        "--radio_port", options['tx_radio_port'],
                        "--stat_ip", options['tx_stat_ip'],
                        "--stat_port", options['tx_stat_port'],
                        "--stat_id", section] + wlans
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('rx'):
                # legacy wfb_rx
                options = config[section]
                argv = [wfbx_server_dir + "wfb_rx",
                        "--ip", options['rx_ip'],
                        "--port", options['rx_port'],
                        "--tx_id", options['rx_tx_id'],
                        "--link_id", options['rx_link_id'],
                        "--radio_port", options['rx_radio_port'],
                        "--stat_ip", options['rx_stat_ip'],
                        "--stat_port", options['rx_stat_port'],
                        "--stat_id", section,
                        "--stat_period", options['rx_stat_period']] + wlans
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('statd'):
                options = config[section]
                argv = [wfbx_server_dir + "wfbx_statd",
                        "--ingest", options['statd_ingest'],
                        "--mcast", options['statd_mcast'],
                        "--host_id", options['statd_host_id'],
                        "--max_len", options['statd_max_len']]
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('statd_fwd'):
                options = config[section]
                argv = [wfbx_server_dir + "statd_fwd",
                        "--mcast", options['stfw_mcast'],
                        "--dst", options['stfw_dst'],
                        "--module-type", options['stfw_module_type'],
                        "--module-id", options['stfw_module_id'],
                        "--host-id", options['stfw_host_id']]

                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

            elif section.startswith('exec'):
                options = config[section]
                argv = [options['exec_exec']]
                param_list = options.get('exec_argv', '').split(' ')
                if param_list != ['']:
                    argv += param_list
                kill_stale_process(argv[0])
                log_mode = options.get('log', defaults.get('log', 'off'))
                log_file = options.get('log_file', wfbx_server_dir + 'log/' + section + '.log')
                p, fh = spawn_module(section, argv, log_mode, log_file, cwd=wfbx_server_dir)
                process_list.append({"name": section, "proc": p, "fh": fh})
                process_id[p.pid] = section

        logging.info("wfbX_server started")

        while True:
            for rec in list(process_list):
                p = rec["proc"]
                rc = p.poll()
                if rc is not None:
                    name = rec["name"]
                    if rc != 0:
                        print(f"[{name}] error! return code: {rc}")
                        logging.error(f"[{name}] error! return code: {rc}")
                        kill_all(process_list, timeout_ms=kill_timeout_ms)
                        print('wfbX_server was terminated...')
                        sys.exit(0)
                    else:
                        logging.info(f"[{name}] exited with code 0")
                        kill_all(process_list, timeout_ms=kill_timeout_ms)
                        print('wfbX_server stopped (module exited)')
                        sys.exit(0)
            time.sleep(0.2)

    except Exception as e:
        print(e)
        kill_all(process_list, timeout_ms=kill_timeout_ms)
        print('wfb_server was terminated...')
        sys.exit(0)


if __name__ == '__main__':
    main()
